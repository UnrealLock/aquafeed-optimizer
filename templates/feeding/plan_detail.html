{% extends "base.html" %}
{% block title %}План кормления{% endblock %}

{% block content %}
<h1 class="mb-4">План кормления</h1>

<div class="card shadow-sm mb-4">
  <div class="card-body">
    <h5 class="card-title mb-3">План</h5>

    <div class="row">
      <div class="col-md-6">
        <ul class="list-unstyled mb-0">
          <li class="mb-2">
            <strong>Аквариум:</strong>
            {{ plan.aquarium.name }} ({{ plan.aquarium.volume_liters }} L)
          </li>
          <li class="mb-2">
            <strong>Корм:</strong>
            {{ plan.food.name }}
          </li>
          <li class="mb-2">
            <strong>Создан:</strong>
            {{ plan.created_at }}
          </li>
        </ul>
      </div>

      <div class="col-md-6">
        <ul class="list-unstyled mb-0">
          <li class="mb-2">
            <strong>Суточная норма:</strong>
            {{ daily_amount_display }} г/день
          </li>
          <li class="mb-2">
            <strong>Кормлений в день:</strong>
            {{ plan.feedings_per_day }}
          </li>
          <li class="mb-2">
            <strong>За одно кормление::</strong>
            {{ per_feeding_display }} g
          </li>
        </ul>
      </div>
    </div>
  </div>
</div>

<div class="card shadow-sm mb-4">
  <div class="card-body">
    <h5 class="card-title mb-3">Прогноз состояния воды</h5>

    {% if forecast %}
      <div class="row">
        <div class="col-md-4 mb-3">
          <div class="p-3 bg-light rounded border">
            <div class="text-muted small">Нитраты (ppm)</div>
            <div class="fs-4 fw-semibold">{{ nitrate_display }}</div>
          </div>
        </div>

        <div class="col-md-4 mb-3">
          <div class="p-3 bg-light rounded border">
            <div class="text-muted small">Фосфаты (ppm)</div>
            <div class="fs-4 fw-semibold">{{ phosphate_display }}</div>
          </div>
        </div>

        <div class="col-md-4 mb-3">
          <div class="p-3 bg-light rounded border">
            <div class="text-muted small">Индекс органической нагрузки</div>
            <div class="fs-4 fw-semibold">{{ organic_display }}</div>
          </div>
        </div>
      </div>

      <div class="text-muted small">
        Прогноз создан: {{ forecast.created_at }}
      </div>
    {% else %}
      <div class="alert alert-warning mb-0">Прогноз недоступен.</div>
    {% endif %}
  </div>
</div>

{% if forecast %}
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h5 class="card-title mb-3">Графики</h5>

      <div class="row">
        <div class="col-lg-6 mb-4">
          <div id="chart-nitrate"></div>
        </div>
        <div class="col-lg-6 mb-4">
          <div id="chart-phosphate"></div>
        </div>
        <div class="col-12">
          <div id="chart-organic"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h5 class="card-title mb-2">30‑дневный прогноз</h5>
      <p class="text-muted small mb-3">
        Прогноз учитывает выбранный режим кормления, наличие аквариумных растений 
        и плановые подмены воды в течение расчётного периода.
      </p>

      <div id="chart-forecast"></div>
    </div>
  </div>

  <script>
    const nitrateFig = JSON.parse('{{ charts.nitrate_json|escapejs }}');
    Plotly.newPlot('chart-nitrate', nitrateFig.data, nitrateFig.layout);

    const phosphateFig = JSON.parse('{{ charts.phosphate_json|escapejs }}');
    Plotly.newPlot('chart-phosphate', phosphateFig.data, phosphateFig.layout);

    const organicFig = JSON.parse('{{ charts.organic_json|escapejs }}');
    Plotly.newPlot('chart-organic', organicFig.data, organicFig.layout);

    const forecastFig = JSON.parse('{{ daily_forecast_chart|escapejs }}');
    Plotly.newPlot('chart-forecast', forecastFig.data, forecastFig.layout);
  </script>
{% endif %}

{% endblock %}