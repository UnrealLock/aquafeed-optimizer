{% extends "base.html" %}
{% block title %}–ü–ª–∞–Ω –∫–æ—Ä–º–ª–µ–Ω–∏—è{% endblock %}

{% block content %}
<h1 class="mb-4">–ü–ª–∞–Ω –∫–æ—Ä–º–ª–µ–Ω–∏—è</h1>

<div class="d-flex gap-2 mb-3">
  <a class="btn btn-outline-secondary" href="{% url 'feeding:plan_list' %}">–ö —Å–ø–∏—Å–∫—É</a>
  <a class="btn btn-outline-danger" href="{% url 'feeding:plan_delete' plan.pk %}">–£–¥–∞–ª–∏—Ç—å</a>
</div>

<div class="card shadow-sm mb-4">
  <div class="card-body">
    <h5 class="card-title mb-3">–ü–ª–∞–Ω</h5>

    <div class="row">
      <div class="col-md-6">
        <ul class="list-unstyled mb-0">
          <li class="mb-2">
            <strong>–ê–∫–≤–∞—Ä–∏—É–º:</strong>
            {{ plan.aquarium.name }} ({{ plan.aquarium.volume_liters }} L)
          </li>
          <li class="mb-2">
            <strong>–ö–æ—Ä–º:</strong>
            {{ plan.food.name }}
          </li>
          <li class="mb-2">
            <strong>–°–æ–∑–¥–∞–Ω:</strong>
            {{ plan.created_at }}
          </li>
        </ul>
      </div>

      <div class="col-md-6">
        <ul class="list-unstyled mb-0">
          <li class="mb-2">
            <strong>–°—É—Ç–æ—á–Ω–∞—è –Ω–æ—Ä–º–∞:</strong>
            {{ daily_amount_display }} –≥/–¥–µ–Ω—å
          </li>
          <li class="mb-2">
            <strong>–ö–æ—Ä–º–ª–µ–Ω–∏–π –≤ –¥–µ–Ω—å:</strong>
            {{ plan.feedings_per_day }}
          </li>
          <li class="mb-2">
            <strong>–ó–∞ –æ–¥–Ω–æ –∫–æ—Ä–º–ª–µ–Ω–∏–µ::</strong>
            {{ per_feeding_display }} g
          </li>
        </ul>
      </div>
    </div>
  </div>
</div>

<div class="card shadow-sm mb-4">
  <div class="card-body">
    <h5 class="card-title mb-3">–ü—Ä–æ–≥–Ω–æ–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤–æ–¥—ã</h5>

    {% if forecast %}
      <div class="row">
        <div class="col-md-4 mb-3">
          <div class="p-3 bg-light rounded border">
            <div class="text-muted small">–ù–∏—Ç—Ä–∞—Ç—ã (ppm)</div>
            <div class="fs-4 fw-semibold">{{ nitrate_display }}</div>
          </div>
        </div>

        <div class="col-md-4 mb-3">
          <div class="p-3 bg-light rounded border">
            <div class="text-muted small">–§–æ—Å—Ñ–∞—Ç—ã (ppm)</div>
            <div class="fs-4 fw-semibold">{{ phosphate_display }}</div>
          </div>
        </div>

        <div class="col-md-4 mb-3">
          <div class="p-3 bg-light rounded border">
            <div class="text-muted small">–ò–Ω–¥–µ–∫—Å –æ—Ä–≥–∞–Ω–∏—á–µ—Å–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏</div>
            <div class="fs-4 fw-semibold">{{ organic_display }}</div>
          </div>
        </div>
      </div>

      <div class="text-muted small">
        –ü—Ä–æ–≥–Ω–æ–∑ —Å–æ–∑–¥–∞–Ω: {{ forecast.created_at }}
      </div>
    {% else %}
      <div class="alert alert-warning mb-0">–ü—Ä–æ–≥–Ω–æ–∑ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.</div>
    {% endif %}
  </div>
</div>

  <div class="mt-3 small text-muted">
    <strong>–û–±–æ–∑–Ω–∞—á–µ–Ω–∏—è:</strong>
    <span class="ms-2">üü¢ —Ö–æ—Ä–æ—à–æ</span>
    <span class="ms-2">üü° –ø—Ä–∏–µ–º–ª–µ–º–æ</span>
    <span class="ms-2">üî¥ –∫—Ä–∏—Ç–∏—á–Ω–æ</span>
  </div>

{% if forecast %}
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h5 class="card-title mb-3">–ì—Ä–∞—Ñ–∏–∫–∏</h5>

      <div class="row">
        <div class="col-lg-6 mb-4">
          <div id="chart-nitrate"></div>
        </div>
        <div class="col-lg-6 mb-4">
          <div id="chart-phosphate"></div>
        </div>
        <div class="col-12">
          <div id="chart-organic"></div>
        </div>
      </div>
    </div>
  </div>


  <div class="mt-3">
    <div class="small text-muted mb-2">
      –û—Ü–µ–Ω–∫–∞ –ø—Ä–æ–≥–Ω–æ–∑–∞ –ø–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏—è–º –∑–∞ 30 –¥–Ω–µ–π:
    </div>

    {% with no3_code=no3_state.0 no3_label=no3_state.1 %}
      <span class="badge {% if no3_code == 'good' %}bg-success{% elif no3_code == 'warn' %}bg-warning text-dark{% else %}bg-danger{% endif %}">
        NO‚ÇÉ max: {{ max_no3|floatformat:3 }} ppm ‚Äî {{ no3_label }}
      </span>
    {% endwith %}

    {% with po4_code=po4_state.0 po4_label=po4_state.1 %}
      <span class="badge ms-2 {% if po4_code == 'good' %}bg-success{% elif po4_code == 'warn' %}bg-warning text-dark{% else %}bg-danger{% endif %}">
        PO‚ÇÑ max: {{ max_po4|floatformat:3 }} ppm ‚Äî {{ po4_label }}
      </span>
    {% endwith %}

    {% with org_code=org_state.0 org_label=org_state.1 %}
      <span class="badge ms-2 {% if org_code == 'good' %}bg-success{% elif org_code == 'warn' %}bg-warning text-dark{% else %}bg-danger{% endif %}">
        –û—Ä–≥–∞–Ω–∏–∫–∞ max: {{ max_org|floatformat:3 }} ‚Äî {{ org_label }}
      </span>
    {% endwith %}

    <div class="mt-2 small text-muted">
      –¶–≤–µ—Ç–∞: –∑–µ–ª—ë–Ω—ã–π ‚Äî —Ö–æ—Ä–æ—à–æ, –∂—ë–ª—Ç—ã–π ‚Äî –ø—Ä–∏–µ–º–ª–µ–º–æ, –∫—Ä–∞—Å–Ω—ã–π ‚Äî –∫—Ä–∏—Ç–∏—á–Ω–æ.
    </div>
  </div>

  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h5 class="card-title mb-2">30‚Äë–¥–Ω–µ–≤–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑</h5>
      <p class="text-muted small mb-3">
        –ü—Ä–æ–≥–Ω–æ–∑ —É—á–∏—Ç—ã–≤–∞–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º –∫–æ—Ä–º–ª–µ–Ω–∏—è, –Ω–∞–ª–∏—á–∏–µ –∞–∫–≤–∞—Ä–∏—É–º–Ω—ã—Ö —Ä–∞—Å—Ç–µ–Ω–∏–π 
        –∏ –ø–ª–∞–Ω–æ–≤—ã–µ –ø–æ–¥–º–µ–Ω—ã –≤–æ–¥—ã –≤ —Ç–µ—á–µ–Ω–∏–µ —Ä–∞—Å—á—ë—Ç–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞.
      </p>

      <div id="chart-forecast"></div>
    </div>
  </div>

  <script>
    const nitrateFig = JSON.parse('{{ charts.nitrate_json|escapejs }}');
    Plotly.newPlot('chart-nitrate', nitrateFig.data, nitrateFig.layout);

    const phosphateFig = JSON.parse('{{ charts.phosphate_json|escapejs }}');
    Plotly.newPlot('chart-phosphate', phosphateFig.data, phosphateFig.layout);

    const organicFig = JSON.parse('{{ charts.organic_json|escapejs }}');
    Plotly.newPlot('chart-organic', organicFig.data, organicFig.layout);

    const forecastFig = JSON.parse('{{ daily_forecast_chart|escapejs }}');
    Plotly.newPlot('chart-forecast', forecastFig.data, forecastFig.layout);
  </script>
{% endif %}

{% endblock %}